---
title: Система Комнаты
---

# Документация по системе комнаты

## Обзор

Система комнаты отвечает за создание и управление 3D пространством кухни, включая адаптацию под размер экрана, центрирование модулей и управление камерой с ограничениями.

## Архитектура

### Основные компоненты

1. **Room** (`app/designer/components/room.tsx`)
   - Отвечает за отрисовку 3D комнаты (пол, стены, потолок)
   - Принимает размеры комнаты как props
   - Создает материалы и геометрию комнаты

2. **ThreeCanvas** (`app/designer/tree-canvas.tsx`)
   - Основной компонент сцены
   - Управляет камерой и OrbitControls
   - Вычисляет размеры комнаты на основе конфигурации кухни

3. **LayoutEngine** (`core/engines/layout-engine/layout-engine.ts`)
   - Генерирует позиции модулей на основе конфигурации
   - Отвечает за размещение модулей в пространстве

### Текущая система позиционирования

#### Размеры комнаты

```typescript
const roomDimensions = {
  width: sideA + margin * 2,    // sideA + 300см запас
  depth: sideB + margin * 2,    // sideB + 300см запас  
  height: height + 100,         // высота + 100см запас
  centerX: sideA / 2 + margin,
  centerZ: -sideB / 2 - margin,
  centerY: height / 2
};
```

#### Позиционирование модулей

- Модули размещаются вдоль стен согласно `layoutLines`
- Каждый модуль позиционируется относительно начала своей линии
- Координаты начинаются с (0, 0, 0) для каждой линии

#### Настройки камеры

```typescript
const cameraSettings = {
  position: [cameraX, cameraY, cameraZ],
  target: [centerX, centerY, centerZ],
  minDistance: maxDimension * 0.3,
  maxDistance: maxDimension * 2.5,
  maxPolarAngle: Math.PI * 0.85
};
```

## Требования к новой системе

### 1. Адаптация камеры под размер экрана

- Отслеживать размеры viewport
- Вычислять оптимальное положение камеры
- Адаптировать FOV для лучшего обзора
- Сохранять физические размеры комнаты неизменными

### 2. Центрирование кухни в комнате

- Разместить всю кухню в центре комнаты
- Сохранить L-образную конфигурацию
- Вычислять центральные координаты для всей кухни
- Сместить все модули относительно центра комнаты

### 3. Ограничения камеры

- Запретить выход камеры за границы комнаты
- Проверять позиции в реальном времени
- Ограничить движение по осям X, Y, Z
- Предотвратить пересечение со стенами

## Новая архитектура

### Файлы для создания

1. **Хук адаптации камеры** (`app/designer/hooks/useViewportCamera.ts`)
   - Отслеживание размеров viewport
   - Вычисление оптимальной позиции камеры
   - Адаптация FOV

2. **OrbitControls с границами** (`app/designer/components/bounded-orbit-controls.tsx`)
   - Расширение стандартных OrbitControls
   - Проверка границ комнаты
   - Ограничение движения камеры

3. **Утилиты границ** (`app/designer/utils/room-boundary-calculator.ts`)
   - Расчет границ комнаты
   - Проверка позиции камеры
   - Вычисление допустимых зон

### Модификации

1. **LayoutEngine** - добавление логики центрирования
2. **Types** - новые интерфейсы для центрирования
3. **ThreeCanvas** - интеграция новой системы

## Алгоритмы

### Центрирование кухни

1. Вычислить общие границы кухни (bounding box)
2. Найти центр этого bounding box
3. Вычислить смещение относительно центра комнаты
4. Применить смещение ко всем модулям

### Проверка границ камеры

1. Получить текущую позицию камеры
2. Проверить нахождение в пределах комнаты
3. Ограничить координаты при необходимости
4. Применить ограничения к OrbitControls

### Адаптация камеры

1. Получить размеры viewport
2. Вычислить соотношение сторон
3. Адаптировать FOV и дистанцию
4. Обновить позицию камеры

## Тестирование

### Сценарии тестирования

1. Изменение размера окна браузера
2. Максимальное приближение/отдаление камеры
3. Попытка выхода за границы комнаты
4. Различные конфигурации кухни
5. Разные размеры экрана (мобильные, десктоп)

### Метрики

- Плавность движения камеры
- Корректность ограничений
- Адаптивность под разные экраны
- Производительность рендеринга