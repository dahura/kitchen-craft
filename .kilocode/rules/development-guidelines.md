# Правила Разработки на Основе Экспертного Заключения

## 1. Архитектурные Принципы

### 1.1. Разделение Слоев
- **Core изоляция:** `core/` НЕ ДОЛЖЕН содержать импорты React, Next.js, Three.js
- **UI изоляция:** `app/` может импортировать из `core/`, но не наоборот
- **Framework-agnostic:** Вся бизнес-логика живет в `core/engines/`

### 1.2. Поток Данных
```
UI/ИИ → KitchenConfig → ValidationEngine → LayoutEngine → RenderableModule[] → 3D Scene
```

### 1.3. Единый Источник Правды
- [`core/types.ts`](../../core/types.ts:1) - единственное место для всех интерфейсов
- Изменения типов требуют обновления всех зависимых компонентов

## 2. Разработка Core Компонентов

### 2.1. Engines
- **Layout Engine:** Только чистые функции, без side effects
- **Validation Engine:** Всегда возвращать `ValidationResult` с `fixedConfig`
- **Иммутабельность:** Не мутировать входные параметры

### 2.2. Libraries
- **Material Library:** Использовать ключи вместо прямых ссылок
- **Module Library:** Определять constraints для каждого варианта
- **Расширяемость:** Новые материалы/модули добавлять через конфигурацию

### 2.3. Types
- **Структура:** Новые поля добавлять в конец интерфейсов
- **Опциональность:** Использовать `?` для необязательных полей
- **Документация:** JSDoc для сложных типов

## 3. Разработка 3D Компонентов (Builders)

### 3.1. Структура Builder
```typescript
export const ComponentName = ({ module }: { module: RenderableModule }) => {
  // useMemo для вычислений
  const geometry = useMemo(() => {
    // Вычисления геометрии
  }, [module]);

  // Рендеринг
  return (
    <group position={[module.position.x, module.position.y, module.position.z]}>
      {/* Геометрия */}
    </group>
  );
};
```

### 3.2. Правила Геометрии
- **Никаких хардкодов:** Все размеры из `module.dimensions`
- **Иерархия:** Использовать вложенные компоненты для сложных объектов
- **Материалы:** Резолвить через `module.materials`

### 3.3. Оптимизация
- **useMemo:** Кэшировать сложные вычисления геометрии
- **Ленивая загрузка:** Для тяжелых моделей использовать dynamic import
- **Batch rendering:** Группировать одинаковые материалы

## 4. Управление Состоянием

### 4.1. Zustand Store
```typescript
// Структура экшенов
interface StoreActions {
  regenerate: () => void;        // Всегда вызывает валидацию + генерацию
  loadConfig: (config) => void;   // Загрузка новой конфигурации
  updateModule: (lineId, moduleId, updates) => void;
  // ... другие экшены
}
```

### 4.2. Паттерны Обновления
- **Иммутабельность:** Всегда создавать новые объекты
- **Атомарность:** Один экшен = одно изменение состояния
- **Автогенерация:** После изменения конфигурации всегда вызывать `regenerate()`

## 5. Валидация и Тестирование

### 5.1. Валидация
- **Многоуровневая:** Input → Validation → Layout → Render
- **Policies:** `warn` | `error` | `auto_fix`
- **Graceful degradation:** Продолжать работу с предупреждениями

### 5.2. Тестирование
- **Unit тесты:** Для всех функций в `core/engines/`
- **Интеграционные тесты:** Для потока данных
- **Visual тесты:** Для 3D компонентов

## 6. UI Компоненты

### 6.1. Структура
```
app/designer/
├── components/
│   ├── ui/           # Общие UI компоненты
│   └── builders/     # 3D строители
├── layout.tsx        # Общая структура страницы
└── page.tsx         # Основной контент
```

### 6.2. Конвенции
- **kebab-case.tsx** для компонентов
- **PascalCase.tsx** для страниц/лайаутов
- **export const** для компонентов
- **export default** для страниц

## 7. Качество Кода

### 7.1. TypeScript
- **Strict mode:** Всегда использовать строгий режим
- **Type safety:** Избегать `any`, использовать конкретные типы
- **Generics:** Для переиспользуемых компонентов

### 7.2. Производительность
- **React.memo:** Для чистых компонентов
- **useMemo/useCallback:** Для дорогих вычислений
- **Code splitting:** Для тяжелых зависимостей

### 7.3. Документация
- **JSDoc:** Для всех публичных функций
- **README:** Для сложных модулей
- **Comments:** Для бизнес-логики

## 8. Процесс Разработки

### 8.1. Порядок Работы
1. **Изменить типы** в `core/types.ts`
2. **Обновить примеры** в `core/examples/`
3. **Модифицировать engines** при необходимости
4. **Обновить builders** для новых фич
5. **Добавить UI компоненты** для управления
6. **Написать тесты**

### 8.2. Code Review Checklist
- [ ] Следует архитектурным принципам
- [ ] Не нарушает изоляцию слоев
- [ ] Имеет необходимые тесты
- [ ] Документирован сложный код
- [ ] Оптимизирован производительность

## 9. Запрещенные Практики

### 9.1. Категорически Запрещено
- **UI импорты в core:** `import React from 'react'` в `core/`
- **Хардкоды размеров:** Все размеры через данные
- **Прямые мутации:** Изменение state без иммутабельности
- **Пропуск валидации:** Обход ValidationEngine

### 9.2. Не Рекомендуется
- **Сложные компоненты:** Разбивать на более мелкие
- **Глубокая вложенность:** Использовать композицию
- **Монолитные файлы:** Разделять по ответственности

## 10. Будущее Развитие

### 10.1. Краткосрочные Цели
- Завершить все builders
- Добавить базовый UI
- Реализовать сохранение/загрузку

### 10.2. Среднесрочные Цели
- AI интеграция
- Экспорт в 3D форматы
- Улучшенная визуализация

### 10.3. Долгосрочные Цели
- VR/AR поддержка
- Коллаборативное редактирование
- Интеграция с производителями

---

**Помни:** Архитектура - это фундамент. Следуй правилам, и система останется масштабируемой и поддерживаемой.